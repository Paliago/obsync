<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Obsync WebSocket Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }

    .connected {
      background-color: #d4edda;
      color: #155724;
    }

    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }

    .message {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .log {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      background-color: #f8f9fa;
    }

    button {
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .primary {
      background-color: #007bff;
      color: white;
    }

    .success {
      background-color: #28a745;
      color: white;
    }

    .danger {
      background-color: #dc3545;
      color: white;
    }

    input,
    textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
    }

    textarea {
      height: 100px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Obsync WebSocket Test</h1>

    <div id="status" class="status disconnected">
      Disconnected
    </div>

    <div>
      <button id="connect" class="primary">Connect</button>
      <button id="disconnect" class="danger">Disconnect</button>
      <button id="ping" class="success">Ping</button>
      <button id="listFiles" class="success">List Files</button>
    </div>

    <div>
      <h3>Upload File</h3>
      <input type="text" id="filePath" placeholder="File path (e.g., 'notes/test.md')" value="test/sample.md">
      <textarea id="fileContent" placeholder="File content">This is a test file uploaded via WebSocket!

## Test Content

- Item 1
- Item 2
- Item 3

**Bold text** and *italic text*.</textarea>
      <button id="upload" class="success">Upload File</button>
    </div>

    <div>
      <h3>Download File</h3>
      <input type="text" id="downloadPath" placeholder="File path to download" value="test/sample.md">
      <button id="download" class="success">Download File</button>
    </div>

    <div>
      <h3>Log</h3>
      <div id="log" class="log"></div>
      <button id="clearLog" class="danger">Clear Log</button>
    </div>
  </div>

  <script>
    let ws = null;
    const wsUrl = 'wss://7swtqyg4id.execute-api.eu-north-1.amazonaws.com/$default';

    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');

    function log (message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = type;
      div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus (connected) {
      if (connected) {
        statusDiv.textContent = 'Connected';
        statusDiv.className = 'status connected';
      } else {
        statusDiv.textContent = 'Disconnected';
        statusDiv.className = 'status disconnected';
      }
    }

    function connect () {
      if (ws && ws.readyState === WebSocket.OPEN) {
        log('Already connected');
        return;
      }

      log(`Connecting to: ${wsUrl}`);
      ws = new WebSocket(wsUrl);

      ws.onopen = function (event) {
        log('WebSocket connected!', 'success');
        updateStatus(true);
      };

      ws.onmessage = function (event) {
        try {
          const data = JSON.parse(event.data);
          log(`Received: ${JSON.stringify(data, null, 2)}`, 'message');

          // Handle specific message types
          if (data.type === 'download_success') {
            document.getElementById('fileContent').value = data.content;
            log(`Downloaded file: ${data.filePath} (version: ${data.version})`, 'success');
          } else if (data.type === 'file_list') {
            log(`Files: ${JSON.stringify(data.files, null, 2)}`, 'success');
          } else if (data.type === 'file_changed') {
            log(`File changed: ${data.filePath} (${data.action})`, 'message');
          }
        } catch (e) {
          log(`Raw message: ${event.data}`, 'message');
        }
      };

      ws.onclose = function (event) {
        log(`WebSocket closed: ${event.code} - ${event.reason}`, 'error');
        updateStatus(false);
      };

      ws.onerror = function (error) {
        log(`WebSocket error: ${error}`, 'error');
        updateStatus(false);
      };
    }

    function disconnect () {
      if (ws) {
        ws.close();
        ws = null;
        updateStatus(false);
        log('Disconnected');
      }
    }

    function sendMessage (message) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('Not connected', 'error');
        return;
      }

      log(`Sending: ${JSON.stringify(message)}`, 'info');
      ws.send(JSON.stringify(message));
    }

    // Event listeners
    document.getElementById('connect').onclick = connect;
    document.getElementById('disconnect').onclick = disconnect;

    document.getElementById('ping').onclick = function () {
      sendMessage({ action: 'ping' });
    };

    document.getElementById('listFiles').onclick = function () {
      sendMessage({ action: 'list' });
    };

    document.getElementById('upload').onclick = function () {
      const filePath = document.getElementById('filePath').value;
      const content = document.getElementById('fileContent').value;

      if (!filePath || !content) {
        log('Please enter file path and content', 'error');
        return;
      }

      sendMessage({
        action: 'upload',
        filePath: filePath,
        content: content
      });
    };

    document.getElementById('download').onclick = function () {
      const filePath = document.getElementById('downloadPath').value;

      if (!filePath) {
        log('Please enter file path to download', 'error');
        return;
      }

      sendMessage({
        action: 'download',
        filePath: filePath
      });
    };

    document.getElementById('clearLog').onclick = function () {
      logDiv.innerHTML = '';
    };

    // Auto-connect on page load
    window.onload = function () {
      log('Page loaded. Click Connect to start testing WebSocket functionality.');
    };
  </script>
</body>

</html>
